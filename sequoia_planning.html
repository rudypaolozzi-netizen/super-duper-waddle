<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Sequoia - Communication Corporate</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23015871'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3E📅%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&family=Bricolage+Grotesque:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Bricolage Grotesque', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        h1, h2, h3 {
            font-family: 'Titillium Web', sans-serif;
        }
        
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #015871 0%, #0a7a99 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .logo-login {
            font-family: 'Titillium Web', sans-serif;
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            color: #015871;
            margin-bottom: 10px;
            letter-spacing: -2px;
        }
        
        .baseline {
            font-size: 14px;
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #015871;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Bricolage Grotesque', sans-serif;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #015871;
        }
        
        .btn {
            background: #015871;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Titillium Web', sans-serif;
            font-weight: 600;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #014058;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .error-message {
            background: #f0c8bf;
            color: #c53030;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        #app {
            display: none;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #015871;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-header {
            font-family: 'Titillium Web', sans-serif;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .sidebar-section h3 {
            color: #015871;
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #015871;
        }
        
        .btn-create {
            background: #dcd494;
            color: #015871;
            margin-bottom: 10px;
        }
        
        .btn-create:hover {
            background: #c9c281;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .folder-list, .user-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .folder-item, .user-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .folder-item:hover, .user-item:hover {
            background: #f0f0f0;
        }
        
        .folder-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .btn-delete {
            background: #f0c8bf;
            color: #c53030;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .planning-area {
            flex: 1;
            overflow-x: auto;
            padding: 20px;
        }
        
        .planning-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .zoom-control {
            display: flex;
            gap: 10px;
        }
        
        .planning-grid {
            background: white;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .grid-header {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            background: #015871;
            color: white;
            font-weight: 600;
        }
        
        .grid-header.three-weeks {
            grid-template-columns: 150px repeat(21, minmax(80px, 1fr));
        }
        
        .grid-cell {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .grid-cell.weekend {
            background: #f9f9f9;
        }
        
        .user-row {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            border-bottom: 1px solid #ddd;
        }
        
        .user-row.three-weeks {
            grid-template-columns: 150px repeat(21, minmax(80px, 1fr));
        }
        
        .user-row:nth-child(even) {
            background: #fafafa;
        }
        
        .user-cell {
            padding: 12px;
            font-weight: 600;
            background: #e3d9ce;
            border-right: 2px solid #015871;
        }
        
        .day-cell {
            padding: 8px;
            border: 1px solid #ddd;
            min-height: 80px;
            position: relative;
            cursor: pointer;
        }
        
        .day-cell:hover {
            background: #f0f8ff;
        }
        
        .day-cell.over-7h {
            background: #000;
            color: white;
        }
        
        .task-block {
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 12px;
            cursor: move;
            position: relative;
        }
        
        .task-hours {
            font-weight: 600;
        }
        
        .task-validated {
            position: absolute;
            top: 2px;
            right: 2px;
            color: #2ecc71;
            font-size: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #015871;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .color-picker-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            cursor: pointer;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Bricolage Grotesque', sans-serif;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Bricolage Grotesque', sans-serif;
            resize: vertical;
            min-height: 80px;
        }
        
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn-export {
            background: #2ecc71;
            color: white;
        }
        
        .btn-export:hover {
            background: #27ae60;
        }
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div id="login-screen">
        <div class="login-box">
            <div class="logo-login">SEQUOIA</div>
            <div class="baseline">communication corporate</div>
            <div id="login-error" class="error-message" style="display:none;"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Identifiant</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-full">Se connecter</button>
            </form>
            <p style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                Par défaut: admin / admin123
            </p>
        </div>
    </div>

    <!-- Application principale -->
    <div id="app">
        <div class="header">
            <div class="logo-header">SEQUOIA</div>
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-small" onclick="logout()">Déconnexion</button>
            </div>
        </div>

        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Dossiers -->
                <div class="sidebar-section">
                    <h3>📁 Dossiers</h3>
                    <button class="btn btn-create btn-small" onclick="openFolderModal()">+ Créer un dossier</button>
                    <input type="text" id="search-folder" placeholder="🔍 Rechercher..." 
                           style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;"
                           oninput="filterFolders(this.value)">
                    <div id="folder-list" class="folder-list"></div>
                </div>

                <!-- Exports -->
                <div class="sidebar-section">
                    <h3>📊 Exports</h3>
                    <div class="export-buttons">
                        <button class="btn btn-export btn-small" onclick="exportByUser()">Export par membre</button>
                        <button class="btn btn-export btn-small" onclick="exportByFolder()">Export par dossier</button>
                    </div>
                </div>

                <!-- Membres -->
                <div class="sidebar-section">
                    <h3>👥 Membres</h3>
                    <button class="btn btn-create btn-small" onclick="openUserModal()">+ Ajouter un membre</button>
                    <div id="user-list" class="user-list"></div>
                </div>
            </div>

            <!-- Zone de planning -->
            <div class="planning-area">
                <div class="planning-controls">
                    <h2 id="week-title">Semaine du <span id="current-week"></span></h2>
                    <div class="zoom-control">
                        <button class="btn btn-small" onclick="previousWeek()">← Semaine préc.</button>
                        <button class="btn btn-small" onclick="toggleZoom()">
                            <span id="zoom-text">Afficher 3 semaines</span>
                        </button>
                        <button class="btn btn-small" onclick="nextWeek()">Semaine suiv. →</button>
                    </div>
                </div>

                <div id="planning-grid" class="planning-grid"></div>
            </div>
        </div>
    </div>

    <!-- Modal Dossier -->
    <div id="folder-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Créer un dossier</h2>
                <button class="btn-close" onclick="closeFolderModal()">×</button>
            </div>
            <form id="folder-form" onsubmit="saveFolderhandle(event)">
                <div class="form-group">
                    <label>Nom du dossier</label>
                    <input type="text" id="folder-name" required>
                </div>
                <div class="form-group">
                    <label>Couleur</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="folder-color" value="#015871">
                        <input type="text" id="folder-color-hex" value="#015871" 
                               pattern="^#[0-9A-Fa-f]{6}$"
                               oninput="document.getElementById('folder-color').value = this.value">
                    </div>
                </div>
                <button type="submit" class="btn btn-full">Créer</button>
            </form>
        </div>
    </div>

    <!-- Modal Membre -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter un membre</h2>
                <button class="btn-close" onclick="closeUserModal()">×</button>
            </div>
            <form id="user-form" onsubmit="saveUser(event)">
                <div class="form-group">
                    <label>Nom complet</label>
                    <input type="text" id="user-name-input" required>
                </div>
                <div class="form-group">
                    <label>Identifiant (login)</label>
                    <input type="text" id="user-username" required>
                </div>
                <button type="submit" class="btn btn-full">Ajouter</button>
                <p style="margin-top:10px; font-size:12px; color:#666;">
                    Mot de passe par défaut: sequoia123
                </p>
            </form>
        </div>
    </div>

    <!-- Modal Tâche -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter des heures</h2>
                <button class="btn-close" onclick="closeTaskModal()">×</button>
            </div>
            <form id="task-form" onsubmit="saveTask(event)">
                <input type="hidden" id="task-id">
                <input type="hidden" id="task-user-id">
                <input type="hidden" id="task-date">
                
                <div class="form-group">
                    <label>Dossier</label>
                    <select id="task-folder" required></select>
                </div>
                <div class="form-group">
                    <label>Heures</label>
                    <input type="number" id="task-hours" step="0.25" min="0" max="24" required>
                </div>
                <div class="form-group">
                    <label>Commentaire</label>
                    <textarea id="task-comment"></textarea>
                </div>
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="btn" style="flex:1;">Enregistrer</button>
                    <button type="button" class="btn btn-delete" onclick="deleteTask()" id="delete-task-btn" style="display:none;">Supprimer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentWeekStart = getMonday(new Date());
        let isThreeWeeksView = false;
        let users = [];
        let folders = [];
        let tasks = [];
        let selectedFolder = null;
        let currentTaskId = null;

        // Fonction pour obtenir le lundi d'une semaine
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Formatage de date
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateFr(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Connexion
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const formData = new FormData();
            formData.append('action', 'login');
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('user-name').textContent = data.user.name;
                    await loadData();
                } else {
                    const errorDiv = document.getElementById('login-error');
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
            }
        });

        // Déconnexion
        async function logout() {
            const formData = new FormData();
            formData.append('action', 'logout');
            await fetch('api.php', { method: 'POST', body: formData });
            location.reload();
        }

        // Chargement des données
        async function loadData() {
            await Promise.all([
                loadUsers(),
                loadFolders(),
                loadTasks()
            ]);
            renderPlanning();
        }

        async function loadUsers() {
            const response = await fetch('api.php?action=get_users');
            users = await response.json();
            renderUserList();
        }

        async function loadFolders() {
            const response = await fetch('api.php?action=get_folders');
            folders = await response.json();
            renderFolderList();
            updateTaskFolderSelect();
        }

        async function loadTasks() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + (isThreeWeeksView ? 20 : 6));
            
            const response = await fetch(`api.php?action=get_tasks&start_date=${formatDate(currentWeekStart)}&end_date=${formatDate(endDate)}`);
            tasks = await response.json();
        }

        // Rendu des listes
        function renderUserList() {
            const list = document.getElementById('user-list');
            list.innerHTML = users.map(u => `
                <div class="user-item">
                    <span>${u.name}</span>
                    <button class="btn btn-delete" onclick="confirmDeleteUser(${u.id})">🗑️</button>
                </div>
            `).join('');
        }

        function renderFolderList() {
            const list = document.getElementById('folder-list');
            list.innerHTML = folders.map(f => `
                <div class="folder-item" data-folder-id="${f.id}">
                    <div style="display:flex; align-items:center;">
                        <div class="folder-color" style="background:${f.color}"></div>
                        <span>${f.name}</span>
                    </div>
                    <button class="btn btn-delete" onclick="confirmDeleteFolder(${f.id})">🗑️</button>
                </div>
            `).join('');
        }

        function filterFolders(search) {
            const items = document.querySelectorAll('.folder-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search.toLowerCase()) ? 'flex' : 'none';
            });
        }

        function updateTaskFolderSelect() {
            const select = document.getElementById('task-folder');
            select.innerHTML = folders.map(f => 
                `<option value="${f.id}">${f.name}</option>`
            ).join('');
        }

        // Rendu du planning
        function renderPlanning() {
            const daysToShow = isThreeWeeksView ? 21 : 7;
            const grid = document.getElementById('planning-grid');
            
            // Mise à jour du titre
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + daysToShow - 1);
            document.getElementById('current-week').textContent = 
                `${formatDateFr(currentWeekStart)} - ${formatDateFr(endDate)}`;

            // En-tête
            let headerHTML = '<div class="grid-header' + (isThreeWeeksView ? ' three-weeks' : '') + '">';
            headerHTML += '<div class="grid-cell">Membre</div>';
            
            for (let i = 0; i < daysToShow; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                const dayNum = date.getDate();
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                headerHTML += `<div class="grid-cell ${isWeekend ? 'weekend' : ''}">${dayName}<br>${dayNum}</div>`;
            }
            headerHTML += '</div>';

            // Lignes des utilisateurs
            let rowsHTML = '';
            users.forEach(user => {
                rowsHTML += '<div class="user-row' + (isThreeWeeksView ? ' three-weeks' : '') + '">';
                rowsHTML += `<div class="user-cell">${user.name}</div>`;
                
                for (let i = 0; i < daysToShow; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = formatDate(date);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    
                    // Calculer le total des heures pour cette date et cet utilisateur
                    const dayTasks = tasks.filter(t => t.user_id === user.id && t.date === dateStr);
                    const totalHours = dayTasks.reduce((sum, t) => sum + parseFloat(t.hours), 0);
                    const over7h = totalHours > 7;
                    
                    rowsHTML += `<div class="day-cell ${isWeekend ? 'weekend' : ''} ${over7h ? 'over-7h' : ''}" 
                                      onclick="openTaskModal(${user.id}, '${dateStr}')"
                                      data-user-id="${user.id}" data-date="${dateStr}">`;
                    
                    dayTasks.forEach(task => {
                        rowsHTML += `<div class="task-block" style="background:${task.folder_color}; color:white;"
                                          onclick="event.stopPropagation(); editTask(${task.id})">
                            <div class="task-hours">${task.hours}h</div>
                            <div style="font-size:10px;">${task.folder_name}</div>
                            ${task.validated ? '<div class="task-validated">✓</div>' : ''}
                        </div>`;
                    });
                    
                    if (totalHours > 0) {
                        rowsHTML += `<div style="font-size:11px; margin-top:4px; font-weight:600;">Total: ${totalHours}h</div>`;
                    }
                    
                    rowsHTML += '</div>';
                }
                
                rowsHTML += '</div>';
            });

            grid.innerHTML = headerHTML + rowsHTML;
        }

        // Navigation semaines
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            loadTasks().then(renderPlanning);
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            loadTasks().then(renderPlanning);
        }

        function toggleZoom() {
            isThreeWeeksView = !isThreeWeeksView;
            document.getElementById('zoom-text').textContent = 
                isThreeWeeksView ? 'Afficher 1 semaine' : 'Afficher 3 semaines';
            loadTasks().then(renderPlanning);
        }

        // Modales
        function openFolderModal() {
            document.getElementById('folder-modal').classList.add('active');
            document.getElementById('folder-name').value = '';
            document.getElementById('folder-color').value = '#015871';
            document.getElementById('folder-color-hex').value = '#015871';
        }

        function closeFolderModal() {
            document.getElementById('folder-modal').classList.remove('active');
        }

        async function saveFolderhandle(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('action', 'add_folder');
            formData.append('name', document.getElementById('folder-name').value);
            formData.append('color', document.getElementById('folder-color').value);

            await fetch('api.php', { method: 'POST', body: formData });
            await loadFolders();
            closeFolderModal();
        }

        function openUserModal() {
            document.getElementById('user-modal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('active');
        }

        async function saveUser(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('action', 'add_user');
            formData.append('name', document.getElementById('user-name-input').value);
            formData.append('username', document.getElementById('user-username').value);

            await fetch('api.php', { method: 'POST', body: formData });
            await loadUsers();
            closeUserModal();
            document.getElementById('user-form').reset();
        }

        function openTaskModal(userId, date) {
            document.getElementById('task-modal').classList.add('active');
            document.getElementById('task-id').value = '';
            document.getElementById('task-user-id').value = userId;
            document.getElementById('task-date').value = date;
            document.getElementById('task-hours').value = '';
            document.getElementById('task-comment').value = '';
            document.getElementById('delete-task-btn').style.display = 'none';
            currentTaskId = null;
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
        }

        async function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('task-modal').classList.add('active');
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-user-id').value = task.user_id;
            document.getElementById('task-date').value = task.date;
            document.getElementById('task-folder').value = task.folder_id;
            document.getElementById('task-hours').value = task.hours;
            document.getElementById('task-comment').value = task.comment || '';
            document.getElementById('delete-task-btn').style.display = 'block';
            currentTaskId = taskId;
        }

        async function saveTask(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('action', 'save_task');
            formData.append('task_id', document.getElementById('task-id').value);
            formData.append('user_id', document.getElementById('task-user-id').value);
            formData.append('folder_id', document.getElementById('task-folder').value);
            formData.append('date', document.getElementById('task-date').value);
            formData.append('hours', document.getElementById('task-hours').value);
            formData.append('comment', document.getElementById('task-comment').value);

            await fetch('api.php', { method: 'POST', body: formData });
            await loadTasks();
            renderPlanning();
            closeTaskModal();
        }

        async function deleteTask() {
            if (!confirm('Supprimer cette tâche ?')) return;
            
            const formData = new FormData();
            formData.append('action', 'delete_task');
            formData.append('id', currentTaskId);

            await fetch('api.php', { method: 'POST', body: formData });
            await loadTasks();
            renderPlanning();
            closeTaskModal();
        }

        async function confirmDeleteFolder(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce dossier ? Toutes les tâches associées seront également supprimées.')) return;
            if (!confirm('Confirmer la suppression ?')) return;

            const formData = new FormData();
            formData.append('action', 'delete_folder');
            formData.append('id', id);

            await fetch('api.php', { method: 'POST', body: formData });
            await loadFolders();
            await loadTasks();
            renderPlanning();
        }

        async function confirmDeleteUser(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce membre ?')) return;

            const formData = new FormData();
            formData.append('action', 'delete_user');
            formData.append('id', id);

            await fetch('api.php', { method: 'POST', body: formData });
            await loadUsers();
            await loadTasks();
            renderPlanning();
        }

        // Exports
        async function exportByUser() {
            const startDate = formatDate(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const response = await fetch(`api.php?action=export_by_user&start_date=${startDate}&end_date=${formatDate(endDate)}`);
            const data = await response.json();
            
            downloadCSV(data, `export_par_membre_${startDate}.csv`);
        }

        async function exportByFolder() {
            const startDate = formatDate(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const response = await fetch(`api.php?action=export_by_folder&start_date=${startDate}&end_date=${formatDate(endDate)}`);
            const data = await response.json();
            
            downloadCSV(data, `export_par_dossier_${startDate}.csv`);
        }

        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('Aucune donnée à exporter');
                return;
            }

            const headers = Object.keys(data[0]);
            let csv = headers.join(';') + '\n';
            
            data.forEach(row => {
                csv += headers.map(h => row[h] || '').join(';') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Synchronisation du color picker
        document.getElementById('folder-color').addEventListener('input', (e) => {
            document.getElementById('folder-color-hex').value = e.target.value;
        });

        // Auto-refresh toutes les 30 secondes
        setInterval(async () => {
            await loadTasks();
            renderPlanning();
        }, 30000);

        // Vérification de session au chargement
        window.addEventListener('load', async () => {
            const response = await fetch('api.php?action=check_session');
            const data = await response.json();
            
            if (data.logged_in) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('user-name').textContent = data.user.name;
                await loadData();
            }
        });
    </script>
</body>
</html>